# openai-usage-logger

**A Python package for logging OpenAI API usage data into MySQL, including tokens, models, and user metadata.**

## Overview

`openai-usage-logger` is a Python package for logging OpenAI API usage data into MySQL, including tokens, models, and user metadata. Supports dynamic fallback for missing IDs, ensuring all API interactions are captured.

## Features

- **Tracks OpenAI API usage**: Logs token usage, models, and user data.
- **MySQL integration**: Stores logs in a MySQL database.
- **Fallback IDs**: Uses default IDs if project, environment, or user IDs are missing.
- **Configurable**: Easily set up for different projects and environments.
- **Reliable logging**: Ensures all API interactions are captured, even with missing data.

### `OpenAIChatHandler`

**Purpose**: The `OpenAIChatHandler` class is designed to handle interactions with the OpenAI API, allowing you to send prompts and receive responses while capturing relevant metadata such as token usage and model details.

#### **Initialization**

```python
OpenAIChatHandler(api_key: str, model: str)
```

### Parameters

- **`api_key`**: Your OpenAI API key, used to authenticate API requests.
- **`model`**: The specific OpenAI model to be used (e.g., `"gpt-3.5-turbo"`).

### Methods

#### `invoke_chat(prompt: str)`

**Purpose**: Sends a prompt to the OpenAI API and returns the response along with detailed metadata.

**Parameters**:
- **`prompt`**: The prompt string to be sent to the API.

**Returns**:
- **`response.content`**: The content generated by the OpenAI model in response to the prompt.
- **`response_metadata`**: A dictionary containing additional metadata:
  - **`token_usage`**: Details of input, output, and total tokens used.
  - **`model_name`**: The name of the model used for the response.
  - **`system_fingerprint`**: A unique identifier for the system processing the request.
  - **`finish_reason`**: The reason the response generation finished (e.g., `"stop"`, `"length"`).
  - **`id`**: The unique identifier for the API response.

**Error Handling**:
- If no response is received, the program will print an error message and exit with a non-zero status code using `sys.exit(1)`.

### `OpenAIUsagePreparer`

**Purpose**: The `OpenAIUsagePreparer` class is designed to take both the prompt and the response metadata from an OpenAI API interaction and prepare them for logging. This class is particularly useful when integrating with projects that already have their own classes handling OpenAI API interactions.

#### **Initialization**
```python
OpenAIUsagePreparer(prompt: str, response_metadata: dict)
```

### Parameters

- **`prompt`**: The prompt string that was sent to the OpenAI API.
- **`response_metadata`**: The usage metadata from the OpenAI API's response, containing information such as token usage, model name, system fingerprint, and more.

### Methods

#### `prepare_for_logging()`

**Purpose**: Prepares the prompt and response metadata for logging by creating a dictionary with the necessary fields.

**Returns**

- A dictionary containing the following fields:
  - **`prompt`**: The original prompt sent to the API.
  - **`input_tokens`**: The number of tokens in the input (prompt).
  - **`output_tokens`**: The number of tokens in the output (response).
  - **`total_tokens`**: The total number of tokens used (input + output).
  - **`model_name`**: The name of the model used for the response.
  - **`system_fingerprint`**: A unique identifier for the system processing the request.
  - **`finish_reason`**: The reason the response generation finished (e.g., `"stop"`, `"length"`).
  - **`response_id`**: The unique identifier for the API response.

### `LLaMaIndexUsagePreparer`

**Purpose**: The `LLaMaIndexUsagePreparer` class is designed to handle and prepare usage metadata from LLaMa Index API responses for logging. This class extracts relevant information such as token usage, model name, system fingerprint, and other metadata, and formats it into a structure suitable for logging.

#### **Initialization**

```python
LLaMaIndexUsagePreparer(prompt: str, response_metadata: dict)
```
### LLaMaIndexUsagePreparer

#### Parameters:

- **`prompt`**: The prompt string that was sent to the LLaMa Index API.
- **`response_metadata`**: The metadata from the LLaMa Index API's response, containing details like token usage, model name, system fingerprint, and more.

#### Methods

- **`prepare_for_logging()`**

  **Purpose**: Prepares the prompt and metadata for logging by creating a dictionary with the necessary fields.

  **Returns**: A dictionary containing the following fields:
  
  - **`prompt`**: The original prompt sent to the API.
  - **`input_tokens`**: The number of tokens in the input (prompt).
  - **`output_tokens`**: The number of tokens in the output (response).
  - **`total_tokens`**: The total number of tokens used (input + output).
  - **`model_name`**: The name of the model used for the response.
  - **`system_fingerprint`**: A unique identifier for the system processing the request.
  - **`finish_reason`**: The reason the response generation finished (e.g., `"stop"`, `"length"`).
  - **`response_id`**: The unique identifier for the API response.

### `OpenAITokenUsageLogger`

**Purpose**: The `OpenAITokenUsageLogger` class is designed to log OpenAI API usage data into a MySQL database. It captures key details such as token usage, model information, and user-related metadata, providing a robust solution for tracking API usage across different projects, environments, and users.

#### **Initialization**

```python
OpenAITokenUsageLogger(db_config: dict, project_id: str = None, environment_id: str = None, user_id: str = None)
```

### Parameters

- **`db_config`**: A dictionary containing MySQL database connection parameters (`user`, `password`, `host`, `database`).
- **`project_id`**: (Optional) The project ID. If not provided, a default "unknown" ID is used.
- **`environment_id`**: (Optional) The environment ID. If not provided, a default "unknown" ID is used.
- **`user_id`**: (Optional) The user ID. If not provided, a default "unknown" ID is used.

### Methods

#### `log_usage(model: str, prompt: str, response_metadata: dict)`

**Purpose**: Logs the OpenAI API usage data into the MySQL database.

**Parameters**:
- **`model`**: The OpenAI model used (e.g., `"gpt-3.5-turbo"`).
- **`prompt`**: The prompt string that was sent to the API.
- **`response_metadata`**: A dictionary containing additional metadata, including:
  - **`token_usage`**: Details of input, output, and total tokens used.
  - **`model_name`**: The name of the model used for the response.
  - **`system_fingerprint`**: A unique identifier for the system processing the request.
  - **`finish_reason`**: The reason the response generation finished (e.g., `"stop"`, `"length"`).
  - **`id`**: The unique identifier for the API response.

**Behavior**:
- If the provided `project_id`, `environment_id`, or `user_id` are `None`, the class will use predefined default IDs to ensure that the usage data is logged.

#### `close()`

**Purpose**: Closes the MySQL connection.

**Usage**: Should be called once logging is complete to ensure that the database connection is properly closed.

### `main.py`

**Purpose**: The `main.py` script orchestrates the interaction between the OpenAI API and the MySQL database. It initializes the necessary components, sends a prompt to the OpenAI model, logs the usage data, and ensures that the data is securely stored in the database.

#### Key Steps in `main.py`:

1. **Environment Configuration**:
   - Retrieves database connection details and the OpenAI API key from environment variables.

2. **Initialization**:
   - Initializes the `OpenAIChatHandler` to handle the communication with the OpenAI API.
   - Initializes the `OpenAITokenUsageLogger` to manage the logging of API usage data into the MySQL database.

3. **Sending a Prompt**:
   - Sends a predefined prompt to the OpenAI API using the `OpenAIChatHandler` and captures the response along with metadata.

4. **Logging Usage Data**:
   - Logs the response data and metadata into the MySQL database using the `OpenAITokenUsageLogger`.

5. **Cleanup**:
   - Closes the database connection and prints a confirmation message to indicate successful execution.

### Script Flow:

- **Start**: The script begins by printing a message to confirm the start of execution.
- **Interaction**: It sends a prompt ("hi") to the OpenAI model and receives a response.
- **Logging**: The API usage details are logged in the MySQL database.
- **End**: The script prints a success message and exits.

This script demonstrates the integration of OpenAI API usage logging with MySQL, providing a complete example of how to capture and store interaction data in a structured manner.

### Environment Variables

To ensure that `main.py` runs correctly, you need to set the following environment variables:

- **`admin_user`**: The username for accessing the MySQL database.
- **`admin_password`**: The password for the MySQL database user.
- **`host_name`**: The hostname of the MySQL database server.
- **`open_ai_api_key`**: Your OpenAI API key used for authenticating API requests.

